<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User-page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        /* Show dropdown on hover */
        #avatarContainer.group:hover #avatarActions {
            opacity: 1;
            scale: 100%;
            pointer-events: auto;
        }
    </style>
</head>

<body class="bg-gray-100 text-[#1C1C1C]">

    <!-- Header -->
    <div class="flex items-center gap-2 px-4 py-4 bg-white fixed top-0 w-full z-50">
        <button onclick="history.back()">
            <i class="fas fa-arrow-left text-gray-700"></i>
        </button>
        <h1 class="text-lg font-semibold text-gray-700">My Profile</h1>
    </div>

    <div class="max-w-sm mx-auto mt-20">

        <!-- Profile Card -->
        <div class="bg-white m-4 -mt-1 p-4 rounded-xl shadow">
            <!-- Avatar -->
        <div class="flex space-x-3">
            <div id="profileAvatar" class="w-[50px] h-[50px] rounded-full flex items-center justify-center 
                bg-gray-200 text-gray-500 cursor-pointer hover:bg-gray-300 transition">
                <i class="fa-solid fa-user text-xl"></i>
            </div>

            <div class="mt-4">
                <h2 class="text-sm text-gray-600 font-medium"></h2>
            </div>
        </div>

            <!-- Hidden File Input -->
            <input type="file" id="uploadInput" accept="image/*" hidden>

            <!-- Modal -->
            <div id="avatarModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-lg p-6 w-64 flex flex-col items-center gap-4 relative">
                    <span id="closeModal"
                        class="absolute top-2 right-2 cursor-pointer text-gray-500 hover:text-gray-700">&times;</span>

                    <!-- Modal Avatar Preview -->
                    <div id="modalAvatar"
                        class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
                        <i class="fa-solid fa-user text-3xl"></i>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-2">
                        <button id="addPhotoBtn" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">Add /
                            Change</button>
                        <button id="removePhotoBtn"
                            class="px-3 py-1 bg-red-500 text-white rounded text-sm">Remove</button>
                    </div>
                </div>
            </div>

            <div class="border-[0.5px] border-gray-100 mt-2"></div>

            <div class="mt-4 space-y-3">
                <div class="flex justify-between items-center">
                    <p class="text-sm text-gray-700">Account Number</p>
                    <div class="flex space-x-3">
                        <p class="text-sm text-gray-400 profile-account"> </p>
                        <i class="fa fa-chevron-right text-[12px] text-gray-400 mt-1"></i>
                    </div>
                </div>

                <div class="border-[0.5px] border-gray-100"></div>

                <div class="flex justify-between items-center">
                    <p class="text-sm text-gray-700">Email</p>
                    <div class="flex space-x-1 align-center">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-4 text-green-600 text-sm font-medium text-green-400" viewBox="0 0 20 20">
                            <path fill="currentColor"
                                d="M10.277 2.084a.5.5 0 0 0-.554 0a15.05 15.05 0 0 1-6.294 2.421A.5.5 0 0 0 3 5v4.5c0 3.891 2.307 6.73 6.82 8.467a.5.5 0 0 0 .36 0C14.693 16.23 17 13.39 17 9.5V5a.5.5 0 0 0-.43-.495a15.05 15.05 0 0 1-6.293-2.421m3.577 5.77l-4 4a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L9.5 10.793l3.646-3.647a.5.5 0 0 1 .708.708" />
                        </svg>
                        <div class="flex space-x-3">
                            <p class="text-sm text-gray-400 profile-email"> <!-- user.email --> </p>
                            <i class="fa fa-chevron-right text-[12px] text-gray-400 mt-1"></i>
                        </div>
                    </div>
                </div>

                <div class="border-[0.5px] border-gray-100"></div>

                <div class="flex justify-between items-center">
                    <p class="text-sm text-gray-700">Nick Name</p>
                    <div class="flex space-x-3">
                        <p class="text-xs text-gray-400 profile-nickName"> </p>
                        <i class="fa fa-chevron-right text-[12px] text-gray-400 mt-1"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Details Card -->
        <div class="bg-white m-4 p-4 rounded-xl shadow space-y-3">
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-700">KYC Levels</p>
                <p class="text-sm font-medium"> </p>
                <i class="fa fa-chevron-right text-[12px] text-gray-400"></i>
            </div>

            <div class="border-[0.5px] border-gray-100"></div>

            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-500 flex items-center gap-1">
                    Full Name <i class="fas fa-info-circle text-xs text-gray-300"></i>
                </p>
                <div class="flex space-x-3">
                    <p class="text-[15px] text-gray-400 profile-fullName"> </p>
                    <i class="fa fa-chevron-right text-[12px] text-gray-400 mt-1"></i>
                </div>
            </div>

            <div class="border-[0.5px] border-gray-100"></div>

            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-700">Gender</p>
                <p class="text-sm font-medium"> </p>
                <i class="fa fa-chevron-right text-[12px] text-gray-400"></i>
            </div>

            <div class="border-[0.5px] border-gray-100"></div>

            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-700">Date of Birth</p>
                <p class="text-sm font-medium"> </p>
                <i class="fa fa-chevron-right text-[12px] text-gray-400"></i>
            </div>

            <div class="border-[0.5px] border-gray-100"></div>

            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-700">Mobile Number</p>
                <div class="flex space-x-3">
                    <p class="text-sm text-gray-400 profile-number"> </p>
                    <i class="fa fa-chevron-right text-[12px] text-gray-400 mt-1"></i>
                </div>
            </div>

            <div class="border-[0.5px] border-gray-100"></div>

            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-700">Address</p>
                <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
            </div>

            <div class="border-[0.5px] border-gray-100"></div>

            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-700">Occupation</p>
                <i class="fa fa-chevron-right text-[12px] text-gray-400"></i>
            </div>
        </div>

        <!-- Management of Accounts -->
        <div class="bg-white m-4 p-4 rounded-xl shadow flex justify-between items-center">
            <p class="text-sm font-sm text-gray-700">Management of Accounts</p>
            <i class="fa fa-chevron-right text-[12px] text-gray-400"></i>
        </div>

        <!-- footer -->
        <div class="bg-white m-4 p-4 rounded-xl shadow space-y-3">
            <div class="flex items-center gap-3 mb-3  flex justify-between">
                <div>
                    <p class="text-sm font-sm text-gray-700">Friends</p>
                    <p class="text-[12px] font-sm text-gray-400">Manage relationships, get benefits.</p>
                </div>
                <i class="fa fa-chevron-right text-[12px] text-gray-400"></i>
            </div>

            <div class="border-[0.5px] border-gray-100"></div>

            <div class="flex items-center gap-3 mb-3  flex justify-between">
                <div>
                    <p class="text-sm font-sm text-gray-700">PalmPay Tag <span
                            class="px-2 bg-orange-300 rounded-br-lg rounded-tr-lg rounded-tl-lg text-[11px] text-white font-sm">New</span>
                    </p>
                    <p class="text-[12px] font-sm text-gray-400">Use unique tag to find your friends.</p>
                </div>
                <i class="fa fa-chevron-right text-[12px] text-gray-400"></i>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader"
        class="fixed inset-0 bg-transparent flex items-center justify-center z-50 transition-opacity duration-500">
        <img src="./bytepayLogo.png" alt="Loading..."
            class="h-20 px-1 py-1 bg-white rounded-lg animate-pulse drop-shadow-[0_0_25px_rgba(37,99,235,0.8)]" />
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // ===== Firebase config =====
        const firebaseConfig = {
            apiKey: "AIzaSyBuvswQZQuVSr3q5gRtFtax07kj5SDrHuU",
            authDomain: "testing-firebase-d7f88.firebaseapp.com",
            projectId: "testing-firebase-d7f88",
            storageBucket: "testing-firebase-d7f88.appspot.com",
            messagingSenderId: "339099724691",
            appId: "1:339099724691:web:83ead43e1d41d2e131d666"
        };

        // ===== Initialize Firebase =====
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ===== Loader =====
        const loader = document.getElementById("loader");
        function showLoader() {
            loader.style.display = "flex";
            document.body.style.overflow = "hidden";
            setTimeout(() => (loader.style.opacity = "1"), 10);
        }
        function hideLoader() {
            loader.style.opacity = "0";
            setTimeout(() => {
                loader.style.display = "none";
                document.body.style.overflow = "";
            }, 500);
        }

        // ===== Elements =====
        const avatar = document.getElementById("profileAvatar");
        const avatarModal = document.getElementById("avatarModal");
        const modalAvatar = document.getElementById("modalAvatar");
        const closeModal = document.getElementById("closeModal");
        const uploadInput = document.getElementById("uploadInput");
        const addPhotoBtn = document.getElementById("addPhotoBtn");
        const removePhotoBtn = document.getElementById("removePhotoBtn");

        // ===== Auth state & load profile =====
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "../palmpay/login/login.html";
                return;
            }

            try {
                showLoader();

                const userDoc = doc(db, "users", user.uid);
                const snap = await getDoc(userDoc);

                if (snap.exists()) {
                    const data = snap.data();

                    // Greeting & profile info
                    document.querySelector("h2").textContent = `Hi, ${data.firstName || "User"}`;
                    document.querySelector(".profile-email").textContent = user.email || "No email";
                    document.querySelector("h2").textContent = `Hi, ${data.firstName}`;
                    document.querySelector(".profile-account").textContent = data.accountNumber || "No Account Number";
                    document.querySelector(".profile-fullName").textContent = `${data.firstName} ${data.lastName}`;
                    document.querySelector(".profile-nickName").textContent = data.firstName;
                    document.querySelector(".profile-number").textContent = data.phoneNumber || "No Mobile Number";

                    const greetingEl = document.querySelector("h2");
                    if (greetingEl) greetingEl.textContent = `Hi, ${data.firstName || "User"}`;

                    const emailEl = document.querySelector(".profile-email");
                    if (emailEl) emailEl.textContent = user.email || "No email";

                    const accountEl = document.querySelector(".profile-account");
                    if (accountEl) accountEl.textContent = data.accountNumber || "No Account Number";

                    const fullNameEl = document.querySelector(".profile-fullName");
                    if (fullNameEl) fullNameEl.textContent = `${data.firstName} ${data.lastName}`;

                    const nickNameEl = document.querySelector(".profile-nickName");
                    if (nickNameEl) nickNameEl.textContent = data.firstName;

                    const numberEl = document.querySelector(".profile-number");
                    if (numberEl) numberEl.textContent = data.phoneNumber || "No Mobile Number";


                    // Load avatar for page & modal
                    if (data.profileImg || user.photoURL) {
                        avatar.style.backgroundImage = `url(${data.profileImg || user.photoURL})`;
                        avatar.style.backgroundSize = "cover";
                        avatar.style.backgroundPosition = "center";
                        avatar.innerHTML = "";

                        modalAvatar.style.backgroundImage = `url(${data.profileImg || user.photoURL})`;
                        modalAvatar.style.backgroundSize = "cover";
                        modalAvatar.style.backgroundPosition = "center";
                        modalAvatar.innerHTML = "";
                    } else {
                        avatar.innerHTML = '<i class="fa-solid fa-user text-xl"></i>';
                        modalAvatar.innerHTML = '<i class="fa-solid fa-user text-3xl"></i>';
                    }
                }
            } catch (err) {
                console.error("Error loading user data:", err);
            } finally {
                hideLoader();
            }
        });

        // ===== Open modal when avatar clicked =====
        avatar.addEventListener("click", () => {
            avatarModal.classList.remove("hidden");
        });

        // ===== Close modal =====
        closeModal.addEventListener("click", () => {
            avatarModal.classList.add("hidden");
        });

        // ===== Open file selector =====
        addPhotoBtn.addEventListener("click", () => {
            uploadInput.click();
        });

        // ===== Upload image to Cloudinary =====
        uploadInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const user = auth.currentUser;
            if (!user) return;

            try {
                showLoader();

                const cloudName = "dut2dpxuc";
                const uploadPreset = "unsigned_preset";

                const formData = new FormData();
                formData.append("file", file);
                formData.append("upload_preset", uploadPreset);

                const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: "POST",
                    body: formData
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message || "Upload failed");

                const imageUrl = data.secure_url;

                // Save URL in Firestore
                await setDoc(doc(db, "users", user.uid), { profileImg: imageUrl }, { merge: true });

                // Update Firebase Auth
                await updateProfile(user, { photoURL: imageUrl });

                // Update modal & avatar
                avatar.style.backgroundImage = `url(${imageUrl})`;
                avatar.style.backgroundSize = "cover";
                avatar.style.backgroundPosition = "center";
                avatar.innerHTML = "";

                modalAvatar.style.backgroundImage = `url(${imageUrl})`;
                modalAvatar.style.backgroundSize = "cover";
                modalAvatar.style.backgroundPosition = "center";
                modalAvatar.innerHTML = "";

                avatarModal.classList.add("hidden");
                console.log("✅ Profile image updated");
            } catch (err) {
                console.error("Upload error:", err);
                alert("Image upload failed");
            } finally {
                hideLoader();
            }
        });

        // ===== Remove profile photo =====
        removePhotoBtn.addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return;

            try {
                showLoader();

                await setDoc(doc(db, "users", user.uid), { profileImg: "" }, { merge: true });
                await updateProfile(user, { photoURL: "" });

                // Reset UI
                avatar.style.backgroundImage = "";
                avatar.innerHTML = '<i class="fa-solid fa-user text-xl"></i>';

                modalAvatar.style.backgroundImage = "";
                modalAvatar.innerHTML = '<i class="fa-solid fa-user text-3xl"></i>';

                avatarModal.classList.add("hidden");
                console.log("✅ Profile image deleted");
            } catch (err) {
                console.error("Delete error:", err);
                alert("Failed to remove profile image");
            } finally {
                hideLoader();
            }
        });
    </script>
</body>

</html>