<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Money</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
</head>

<body class="bg-[#f8f8ff] text-[#1a1a1a] font-sans">

    <div class="max-w-sm mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between px-4 py-3 bg-[#f8f8ff] fixed top-0 w-full z-50">
            <div class="text-lg font-medium text-gray-800 flex items-center gap-2">
                <button onclick="history.back()">
                    <i class="fas fa-arrow-left text-lg text-gray-600"></i>
                </button>
                Add Money
            </div>
            <a href="#" class="text-blue-500 text-sm font-sm">FAQs</a>
        </div>

        <!-- Main Section -->
        <div class="p-4 space-y-6 mt-14">

            <!-- Via Bank Transfer -->
            <div class="bg-white rounded-xl p-4 shadow space-y-3">
                <div class="flex items-start gap-3">
                    <div class="bg-blue-100 text-blue-600 rounded-lg px-2 py-1">
                        <i class="fas fa-bank text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm">Via Bank Transfer</p>
                        <p class="text-xs text-gray-500">FREE Instant bank funding within 10s</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 text-xs mt-1"></i>
                </div>

                <div class="w-full h-px border-t border-dashed border-gray-300 my-4"></div>

                <!-- Account Number -->
                <div>
                    <div class="flex space-x-2">
                        <p class="text-xs text-gray-500">PalmPay Account Number
                        <div class="flex text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 -mr-3 z-10 text-blue-500"
                                viewBox="0 0 24 24">
                                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="1.5">
                                    <path d="M12.75 16V8L10 10" />
                                    <path
                                        d="M7.805 3.469C8.16 3.115 8.451 3 8.937 3h6.126c.486 0 .778.115 1.132.469l4.336 4.336c.354.354.469.646.469 1.132v6.126c0 .5-.125.788-.469 1.132l-4.336 4.336c-.354.354-.646.469-1.132.469H8.937c-.5 0-.788-.125-1.132-.469L3.47 16.195c-.355-.355-.47-.646-.47-1.132V8.937c0-.5.125-.788.469-1.132z" />
                                </g>
                            </svg>
                            <span class="mt-[1px] text-[11px] px-3 bg-blue-100 rounded-full">Upgrade to Tier 2 <i
                                    class="fa fa-chevron-right"></i></span>
                        </div>
                    </div>
                    </p>
                    <div class="flex items-center text-2xl mt-2 font-semibold text-[#1a1a1a] tracking-wider">
                        <div class="flex items-center mt-4 relative">
  <span class="profile-account font-semibold text-lg">Loading...</span>
  <i id="copy" class="far fa-copy text-blue-600 ml-3 cursor-pointer"></i>

  
  <!-- âœ… Tooltip -->
  <span id="tooltip" class="absolute right-8 bg-black text-white text-xs rounded px-2 py-1 opacity-0 transition-opacity duration-300">
    Copied!
  </span>
</div>
                    </div>
                </div>

                <button
                    class="w-full mt-4 py-2 bg-blue-600 text-white rounded-lg font-sm flex items-center justify-center gap-2">
                    <i class="fas fa-share-alt"></i> Share Account
                </button>
            </div>

            <div class="flex items-center my-4">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="px-3 text-sm text-gray-400 font-semibold">OR</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <div class="space-y-3">
                <!-- Cash Deposit -->
                <div class="flex items-center justify-between bg-white p-3 rounded-xl shadow">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-purple-600 rounded-full px-2  py-1">
                            <i class="fas fa-money-bill-wave text-xl "></i>
                        </div>
                        <div>
                            <p class="font-sm text-sm text-gray-900">Cash Deposit
                                <span class="text-xs bg-orange-500 text-white px-2  rounded-br rounded-t ml-1">Win
                                    â‚¦999</span>
                            </p>
                            <p class="text-xs text-gray-500">Fund your account with nearby agents</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                </div>

                <!-- Top-up with Card/Account (Trigger) -->
                <div class="max-w-sm mx-auto">
                    <div id="topupBtn"
                        class="flex items-center justify-between bg-white p-3 rounded-xl shadow cursor-pointer">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 text-blue-600 rounded-full px-2 py-1">
                                <i class="fas fa-credit-card text-xl"></i>
                            </div>
                            <div>
                                <p class="font-sm text-sm text-gray-900">Top-up with Card/Account</p>
                                <p class="text-xs text-gray-500">Add money from your bank card/account</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                    </div>

                    <!-- Modal Background -->
                    <div id="topupModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50">
                        <!-- Modal Content (bottom sheet style) -->
                        <div id="modalContent"
                            class="absolute bottom-0 w-full bg-[#f5f5fa] rounded-t-2xl p-6 shadow-lg animate__animated">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold text-gray-800">Top-up with Card/Account</h2>
                                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Add this somewhere in your page (hidden by default) -->
                            <div id="pinModalTopup"
                                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                                <div class="bg-white p-6 rounded-lg w-80">
                                    <h2 class="text-lg font-semibold mb-4">Enter Transaction PIN</h2>
                                    <input id="pinInputTopup" type="password" maxlength="6" placeholder="6-digit PIN"
                                        class="w-full border p-2 rounded mb-4 text-center text-lg" />
                                    <div class="flex justify-between">
                                        <button id="cancelPinTopup"
                                            class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                                        <button id="confirmPinTopup"
                                            class="px-4 py-2 bg-blue-600 text-white rounded">Confirm</button>
                                    </div>
                                </div>
                            </div>


                            <!-- Fund Method -->
                            <div class="mb-6">
                                <p class="text-sm text-gray-600 mb-2">Fund Method</p>
                                <button
                                    class="w-full border-0 text-blue-600 bg-white font-sm py-3 rounded-xl flex items-center justify-center gap-2">
                                    <i class="fas fa-credit-card"></i>
                                    Add Bank Card/Account
                                </button>
                            </div>

                            <!-- Enter or Select Amount -->
                            <div class="mb-2">
                                <p class="text-sm text-gray-600 mb-2">Enter or select amount</p>
                            </div>
                            <div class="bg-white rounded-lg p-4 mb-4">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="text-gray-700 font-medium">â‚¦</span>
                                    <input type="text" id="amount" placeholder="Enter 100~9,999"
                                        class="flex-1 border-none focus:ring-0 focus:outline-none text-gray-700 text-sm font-sm">
                                    <button id="addMoneyBtn"
                                        class="bg-blue-600 text-white px-2 py-1 rounded-lg disabled:bg-blue-200">Add
                                        Money</button>
                                </div>
                                <!-- Quick Select Buttons -->
                                <div class="grid grid-cols-3 gap-3">
                                    <button
                                        class="border-0 rounded-lg py-2 bg-[#f5f5fa] text-gray-700 hover:bg-blue-100">â‚¦200</button>
                                    <button
                                        class="border-0 rounded-lg py-2 bg-[#f5f5fa] text-gray-700 hover:bg-blue-100">â‚¦1,000</button>
                                    <button
                                        class="border-0 rounded-lg py-2 bg-[#f5f5fa] text-gray-700 hover:bg-blue-100">â‚¦2,000</button>
                                    <button
                                        class="border-0 rounded-lg py-2 bg-[#f5f5fa] text-gray-700 hover:bg-blue-100">â‚¦3,000</button>
                                    <button
                                        class="border-0 rounded-lg py-2 bg-[#f5f5fa] text-gray-700 hover:bg-blue-100">â‚¦5,000</button>
                                    <button
                                        class="border-0 rounded-lg py-2 bg-[#f5f5fa] text-gray-700 hover:bg-blue-100">â‚¦9,999</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- USSD -->
                <div class="flex items-center justify-between bg-white p-3 rounded-xl shadow">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-100 text-indigo-600 rounded-full px-3 py-1">
                            <i class="fas fa-hashtag text-xl"></i>
                        </div>
                        <div>
                            <p class="font-sm text-sm text-gray-900">USSD</p>
                            <p class="text-xs text-gray-500">Use your other bankâ€™s USSD code</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                </div>

                <!-- Receive Money -->
                <div class="flex items-center justify-between bg-white p-3 rounded-xl shadow">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 text-blue-600 rounded-full px-2 py-1">
                            <i class="fas fa-download text-xl"></i>
                        </div>
                        <div>
                            <p class="font-sm text-sm text-gray-900">Receive money</p>
                            <p class="text-xs text-gray-500">Share your account and ask for transfer</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                </div>
            </div>

            <div id="slider" class="relative overflow-hidden border my-3 rounded-lg relative">
                <div id="slides" class="flex w-full h-[80px] transition-transform duration-700 ease-in-out">
                    <img src="./img1.jpg" class="w-full flex-shrink-0" alt="Slide 1" />
                    <img src="./img2.jpg" class="w-full flex-shrink-0" alt="Slide 2" />
                    <img src="./img3.jpg" class="w-full flex-shrink-0" alt="Slide 3" />
                    <img src="./img4.jpg" class="w-full flex-shrink-0" alt="Slide 4" />
                    <img src="./img5.jpg" class="w-full flex-shrink-0" alt="Slide 5" />
                    <img src="./img6.jpg" class="w-full flex-shrink-0" alt="Slide 6" />
                </div>
            </div>

            <div id="nav-dots"
                class="flex justify-center  gap-2 absolute top-[104.5%] left-1/2 -translate-x-1/2 flex gap-2 z-10">
            </div>
        </div>

        <!-- âœ… Success Modal -->
        <div id="successModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-lg p-6 w-80 text-center animate__animated animate__fadeInUp">

                <!-- Icon -->
                <div class="flex items-center justify-center mb-4">
                    <div
                        class="bg-blue-500 text-white w-16 h-16 flex items-center justify-center rounded-full shadow-md">
                        <i class="fas fa-check text-2xl"></i>
                    </div>
                </div>

                <!-- Title -->
                <h2 class="text-lg font-semibold text-blue-600">Top-up Successful!</h2>

                <!-- Amount Added -->
                <p class="mt-3 text-gray-700 text-base">
                    You added <span id="successAmount" class="font-bold text-blue-600"></span>
                </p>

                <!-- New Balance -->
                <p class="mt-1 text-gray-600 text-sm">
                    <span id="successBalance" class="font-medium"></span>
                </p>

                <!-- Button -->
                <button id="closeSuccess"
                    class="mt-5 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl shadow-md transition-all">
                    OK
                </button>
            </div>
        </div>

        <div id="loader"
            class="fixed inset-0 bg-transparent flex items-center justify-center z-50 transition-opacity duration-500"
            style="display:none; opacity:0;">
            <img src="./bytepayLogo.png" alt="Loading..."
                class="h-20 px-1 py-1 rounded-lg bg-white animate-pulse drop-shadow-[0_0_25px_rgba(37,99,235,0.8)]" />
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
            import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
            import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
            const bcrypt = window.dcodeIO ? window.dcodeIO.bcrypt : window.bcrypt;

            // âœ… Your Firebase config here
            const firebaseConfig = {
                apiKey: "AIzaSyBuvswQZQuVSr3q5gRtFtax07kj5SDrHuU",
                authDomain: "testing-firebase-d7f88.firebaseapp.com",
                projectId: "testing-firebase-d7f88",
                storageBucket: "testing-firebase-d7f88.appspot.com",
                messagingSenderId: "339099724691",
                appId: "1:339099724691:web:83ead43e1d41d2e131d666"
            };

            // âœ… Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            // const storage = getStorage(app);

            // ðŸ”¹ Slider logic (unchanged)
            const slides = document.getElementById("slides");
            const navDots = document.getElementById("nav-dots");
            let index = 0;
            const totalSlides = 6;

            for (let i = 0; i < totalSlides; i++) {
                const dot = document.createElement("button");
                dot.className = "w-1 h-1 rounded-full bg-gray-400 hover:bg-white transition-all";
                dot.dataset.index = i;
                navDots.appendChild(dot);
            }
            const dots = navDots.querySelectorAll("button");

            function showSlide(i) {
                index = i;
                slides.style.transform = `translateX(-${index * 100}%)`;
                updateDots();
            }
            function updateDots() {
                dots.forEach((dot, i) => {
                    dot.classList.toggle("bg-gray-800", i === index);
                    dot.classList.toggle("bg-gray-400", i !== index);
                });
            }
            setInterval(() => {
                index = (index + 1) % totalSlides;
                showSlide(index);
            }, 3000);
            dots.forEach(dot => {
                dot.addEventListener("click", () => {
                    showSlide(parseInt(dot.dataset.index));
                });
            });

            document.addEventListener("DOMContentLoaded", () => {
                // ------------------- DOM Elements -------------------
                const topupBtn = document.getElementById("topupBtn");
                const topupModal = document.getElementById("topupModal");
                const modalContent = document.getElementById("modalContent");
                const closeModalBtn = document.getElementById("closeModal");
                const amountInput = document.getElementById("amount");
                const addMoneyBtn = document.getElementById("addMoneyBtn");
                const loader = document.getElementById("loader");

                const pinModal = document.getElementById("pinModalTopup");
                const pinInput = document.getElementById("pinInputTopup");
                const cancelPinBtn = document.getElementById("cancelPinTopup");
                const confirmPinBtn = document.getElementById("confirmPinTopup");

                const successModal = document.getElementById("successModal");
                const successAmount = document.getElementById("successAmount");
                const successBalance = document.getElementById("successBalance");
                const closeSuccessBtn = document.getElementById("closeSuccess");

                // ------------------- Loader Functions -------------------
                const showLoader = () => {
                    if (loader) {
                        loader.style.display = "flex";
                        loader.style.opacity = "1";
                        document.body.style.overflow = "hidden";
                    }
                };

                const hideLoader = () => {
                    if (loader) {
                        loader.style.opacity = "0";
                        setTimeout(() => {
                            loader.style.display = "none";
                            document.body.style.overflow = "";
                        }, 300);
                    }
                };

                // ------------------- Modal Functions -------------------
                const openModal = () => {
                    topupModal.classList.remove("hidden");
                    modalContent.classList.remove("animate__fadeOutDown");
                    modalContent.classList.add("animate__slideInUp");
                };

                const closeModal = () => {
                    modalContent.classList.remove("animate__slideInUp");
                    modalContent.classList.add("animate__fadeOutDown");
                    setTimeout(() => topupModal.classList.add("hidden"), 500);
                };

                const showSuccessModal = (addedAmount, newBalance) => {
                    if (successAmount) successAmount.textContent = `â‚¦${addedAmount.toLocaleString()}`;
                    if (successBalance) successBalance.textContent = `New Balance: â‚¦${newBalance.toLocaleString()}`;
                    if (successModal) successModal.classList.remove("hidden");
                };

                const closeSuccessModal = () => {
                    if (successModal) successModal.classList.add("hidden");
                };

                // ------------------- Event Listeners -------------------
                if (topupBtn) topupBtn.addEventListener("click", openModal);
                if (closeModalBtn) closeModalBtn.addEventListener("click", closeModal);
                if (closeSuccessBtn) closeSuccessBtn.addEventListener("click", closeSuccessModal);

                // Quick select buttons inside modal
                document.querySelectorAll("#modalContent .grid button").forEach(btn => {
                    btn.addEventListener("click", () => {
                        let val = parseInt(btn.textContent.replace(/[â‚¦,]/g, ""), 10);
                        let current = parseInt(amountInput.value || "0", 10);
                        if (isNaN(current)) current = 0;
                        amountInput.value = current + val;
                    });
                });

                // Add Money Flow 
                if (addMoneyBtn) {
                    addMoneyBtn.addEventListener("click", () => {
                        let amt = parseInt(amountInput.value, 10);
                        if (!amt || amt <= 0) { alert("Please enter a valid amount."); return; }
                        pinModal.classList.remove("hidden");
                        pinInput.value = "";
                        pinInput.focus();
                    });
                }

                // Cancel PIN modal
                if (cancelPinBtn) cancelPinBtn.addEventListener("click", () => pinModal.classList.add("hidden"));

                // Confirm PIN -> show loader -> process transaction
                if (confirmPinBtn) {
                    confirmPinBtn.addEventListener("click", async () => {
                        const pin = pinInput.value.trim();
                        if (!pin) { alert("Please enter your PIN."); return; }

                        const user = auth.currentUser;
                        if (!user) { alert("No user logged in."); return; }

                        // âœ… Show loader after PIN is entered
                        showLoader();

                        try {
                            const userRef = doc(db, "users", user.uid);
                            const userSnap = await getDoc(userRef);
                            if (!userSnap.exists()) { alert("User not found."); hideLoader(); return; }

                            const storedPinHash = userSnap.data().transactionPin; // bcrypt hashed PIN
                            const isValidPin = await bcrypt.compare(pin, storedPinHash);

                            if (!isValidPin) { alert("Invalid transaction PIN"); hideLoader(); return; }

                            // Update balance
                            let amount = parseInt(amountInput.value, 10);
                            let currentBalance = userSnap.data().accountBalance ?? 0;
                            let newBalance = currentBalance + amount;
                            await updateDoc(userRef, { accountBalance: newBalance });

                            // Save transaction
                            const txRef = collection(db, "users", user.uid, "transactions");
                            await addDoc(txRef, {
                                amount,
                                type: "credit",
                                status: "success",
                                description: "Wallet Top-up",
                                date: serverTimestamp()
                            });

                            // Show success
                            showSuccessModal(amount, newBalance);
                            amountInput.value = "";
                            pinInput.value = "";
                            pinModal.classList.add("hidden");
                            closeModal();
                        } catch (err) {
                            console.error("Error adding money:", err);
                            alert("Something went wrong. Please try again.");
                        } finally {
                            hideLoader();
                        }
                    });
                }

                // Make functions global 
                window.openModal = openModal;
                window.closeModal = closeModal;
                window.showSuccessModal = showSuccessModal;
                window.closeSuccessModal = closeSuccessModal;

                // Loader element
// const loader = document.getElementById("loader");
const accountSpan = document.querySelector(".profile-account");
const copyBtn = document.getElementById("copy");
const tooltip = document.getElementById("tooltip");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    loader.style.display = "none"; // hide loader if not logged in
    return;
  }

  try {
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      const data = userSnap.data();
      const accountNumber = data.accountNumber || "No Account Number";

      // Show account number
      accountSpan.textContent = accountNumber;
      
      // Hide loader after data loads
      loader.style.display = "none";

      // âœ… Copy logic with tooltip
      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(accountNumber);

          // Show tooltip
          tooltip.style.opacity = "1";
          setTimeout(() => {
            tooltip.style.opacity = "0";
          }, 1200);
        } catch (err) {
          console.error("Copy failed:", err);
        }
      });
    } else {
      loader.style.display = "none";
    }
  } catch (error) {
    console.error("Error fetching account number:", error);
    loader.style.display = "none";
  }
});
            });
        </script>
</body>
</html>